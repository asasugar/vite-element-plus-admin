const u=Object.prototype.toString;function y(i,e){return u.call(i)===`[object ${e}]`}function b(i){return i!==void 0}function g(i){return!b(i)}function c(i){return i!==null&&y(i,"Object")}function x(i){return i===null}function v(i){return g(i)||x(i)}function k(i){return typeof i=="function"}class w{constructor({data:e=[],scope:o={},orderedKey:t=[],filters:s=[],title:r=[],footer:n=[],keyMap:a={},name:l="excel",type:h="xls",onStart:f=()=>{},onSuccess:d=()=>{},onError:p=m=>{console.log(m)}}){this.data=e,this.scope=o,this.filters=s,this.footer=n,this.orderedKey=t,this.keyMap=a,this.name=l,this.title=r,this.type=h,this.onStart=f,this.onSuccess=d,this.onError=p}generate(){var e;{if(this.data&&this.data.length)return this.onStart&&this.onStart(),e=this.getProcessedJson(this.data),e=this.toChsKeys(e),this.type=="csv"?this.export(this.jsonToCSV(e),this.name+"."+this.type,"application/csv"):this.export(this.jsonToXLS(e),this.name+"."+this.type,"application/vnd.ms-excel");this.onError&&this.onError()}}getObjLastValue(e,o){var t,s;return c(o)?(t=Object.keys(o)[0],s=Object.values(o)[0],this.getObjLastValue(e[t],s)):e[o]}toChsKeys(e){return e.map(o=>{let t={};if(this.orderedKey&&this.orderedKey.length)for(var s of this.orderedKey)t[s]=o[s];if(this.filters&&this.filters.length)for(var r of this.filters)delete t[r];if(this.scope&&Object.keys(this.scope).length){var n,a=Object.keys(t).length?t:o;for(n in a)this.scope.hasOwnProperty(n)?t[n]=this.getObjLastValue(a[n],this.scope[n]):t[n]=a[n]}if(this.keyMap&&Object.keys(this.keyMap).length){let h=Object.keys(t).length?t:o;for(var l in h)this.keyMap.hasOwnProperty(l)&&(t[this.keyMap[l]]=h[l],delete h[l])}return Object.keys(t).length?t:o})}download(e,o){if(window.navigator&&window.navigator.msSaveOrOpenBlob)window.navigator.msSaveOrOpenBlob(e,o);else{const t=document.createElement("a");e=window.URL.createObjectURL(e),t.href=e,t.setAttribute("download",o),t.innerHTML="downloading...",t.style.display="none",document.body.appendChild(t),setTimeout(()=>{t.click(),document.body.removeChild(t),setTimeout(()=>{self.URL.revokeObjectURL(t.href)},250)},66)}}export(e,o,t){new Promise(s=>{var r=this.base64ToBlob(e,t);s(this.download(r,o))}).then(()=>{this.onSuccess&&this.onSuccess()}).catch(s=>{this.onError&&this.onError(s)})}jsonToXLS(e){let o="<thead><tr>";if(this.title&&this.title.length){for(var t of this.title)o+=`<th colspan=${t.colspan}>`+t.name;o+="<th></tr>"}for(var s in e[0])o+="<th>"+s+"</th>";if(o=o+"</tr></thead><tbody>",e.map(n=>{for(var a in o+="<tbody><tr>",n)o+=`<td>${n[a]}</td>`;o+="</tr></tbody>"}),this.footer&&this.footer.length){o+="<tfooter><tr>";for(var r of this.footer)o+=`<th colspan=${r.colspan}>`+r.name;o+="<th></tr></tr></tfooter>"}return'<html xmlns:o="urn:schemas-microsoft-com:office:office" xmlns:x="urn:schemas-microsoft-com:office:excel" xmlns="http://www.w3.org/TR/REC-html40"><head><meta name=ProgId content=Excel.Sheet> <meta name=Generator content="Microsoft Excel 11"><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><!--[if gte mso 9]><xml><x:ExcelWorkbook><x:ExcelWorksheets><x:ExcelWorksheet><x:Name>{worksheet}</x:Name><x:WorksheetOptions><x:DisplayGridlines/></x:WorksheetOptions></x:ExcelWorksheet></x:ExcelWorksheets></x:ExcelWorkbook></xml><![endif]--><style type="text/css">td{mso-number-format:@;}</style></head><body><table>${table}</table></body></html>'.replace("${table}",o)}jsonToCSV(e){var o,t="";if(this.title&&this.title.length){for(var s of this.title)t+=""+s.name;t+=`\r
`}for(o in e[0])t+=o+",";if(t=t.slice(0,t.length-1),t+=`\r
`,e.map(n=>{for(var a in n){let l=n[a]+"";l.match(/[,"\n]/)&&(l='"'+l.replace(/\"/g,'""')+'"'),t+=l+","}t=t.slice(0,t.length-1),t+=`\r
`}),this.footer&&this.footer.length){for(var r of this.footer)t+=""+r.name;t+=`\r
`}return t}getProcessedJson(e){let o=this.getKeys(e),t=[];return e.map(s=>{let r={};for(var n in o){var a=o[n];r[n]=this.getNestedData(a,s)}t.push(r)}),t}getKeys(e){let o={};for(var t in e[0])o[t]=t;return o}getNestedData(e,o){let t=null;var s=(""+(c(e)?e.field:e)).split(".");t=o[s[0]];for(let r=1;r<s.length;r++)t=t[s[r]];return t=v(t=this.callItemCallback(e,t))?"":t}callItemCallback(e,o){return c(e)&&k(e.callback)?e.callback(o):o}base64ToBlob(e,o){e=window.btoa(window.unescape(encodeURIComponent(e)));let t=window.atob(e),s=t.length,r=new Uint8ClampedArray(s);for(;s--;)r[s]=t.charCodeAt(s);return new Blob([r],{type:o})}}export{w as J};
